import React, { useState } from 'react';
import { TrendingUp, Search, BarChart3, Newspaper, Brain, AlertCircle, DollarSign, Activity } from 'lucide-react';

const StockAnalyzer = () => {
  const [ticker, setTicker] = useState('');
  const [analysis, setAnalysis] = useState(null);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('analysis');

  const analyzeStock = async () => {
    if (!ticker.trim()) return;
    
    setLoading(true);
    setAnalysis(null);

    try {
      // Ricerca informazioni aggiornate sul titolo
      const searchResponse = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          tools: [
            {
              type: "web_search_20250305",
              name: "web_search"
            }
          ],
          messages: [
            {
              role: "user",
              content: `Cerca informazioni aggiornate sull'azione ${ticker.toUpperCase()} e fornisci un'analisi completa in formato JSON con questa struttura esatta:
              
{
  "company": "Nome completo azienda",
  "sector": "Settore",
  "currentPrice": "Prezzo corrente (numero)",
  "priceChange": "Variazione % (con + o -)",
  "marketCap": "Capitalizzazione di mercato",
  "fundamentals": {
    "pe": "P/E ratio",
    "revenue": "Fatturato recente",
    "eps": "Utile per azione"
  },
  "technicalAnalysis": {
    "trend": "Rialzista/Ribassista/Laterale",
    "support": "Livello supporto",
    "resistance": "Livello resistenza",
    "indicators": "RSI, MACD, etc."
  },
  "recentNews": [
    {"title": "Titolo notizia", "summary": "Breve riassunto", "date": "Data"},
    {"title": "Titolo notizia", "summary": "Breve riassunto", "date": "Data"}
  ],
  "aiInsights": {
    "strengths": ["Pro 1", "Pro 2", "Pro 3"],
    "risks": ["Rischio 1", "Rischio 2", "Rischio 3"],
    "outlook": "Prospettive a breve-medio termine"
  },
  "recommendation": {
    "action": "Acquisto/Attesa/Vendita",
    "confidence": "Alta/Media/Bassa",
    "reasoning": "Spiegazione del rating",
    "targetPrice": "Prezzo obiettivo stimato"
  }
}

Importante: 
- Usa dati reali e aggiornati dalla ricerca web
- Sii obiettivo e bilanciato
- Indica chiaramente i rischi
- Rispondi SOLO con il JSON, senza testo aggiuntivo`
            }
          ]
        })
      });

      const data = await searchResponse.json();
      
      // Estrai il testo dalla risposta
      let responseText = '';
      for (const block of data.content) {
        if (block.type === 'text') {
          responseText += block.text;
        }
      }

      // Pulisci e parsa il JSON
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const cleanJson = jsonMatch[0].replace(/```json|```/g, '').trim();
        const parsedData = JSON.parse(cleanJson);
        setAnalysis(parsedData);
      } else {
        throw new Error('Formato risposta non valido');
      }

    } catch (error) {
      console.error('Errore analisi:', error);
      setAnalysis({
        error: true,
        message: 'Impossibile recuperare i dati. Verifica il ticker e riprova.'
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-6">
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-8">
        <div className="flex items-center gap-3 mb-2">
          <div className="p-3 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-xl">
            <TrendingUp className="w-8 h-8" />
          </div>
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">
              Analizzatore Investimenti AI
            </h1>
            <p className="text-slate-400 text-sm">Analisi azionarie potenziate dall'intelligenza artificiale</p>
          </div>
        </div>

        {/* Disclaimer prominente */}
        <div className="mt-4 bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 flex gap-3">
          <AlertCircle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-amber-200">
            <strong>‚ö†Ô∏è Importante:</strong> Questa √® un'analisi informativa, non un consiglio finanziario. 
            I mercati sono imprevedibili. Consulta sempre un professionista prima di investire.
          </div>
        </div>
      </div>

      {/* Search Bar */}
      <div className="max-w-7xl mx-auto mb-8">
        <div className="flex gap-3">
          <div className="flex-1 relative">
            <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
            <input
              type="text"
              value={ticker}
              onChange={(e) => setTicker(e.target.value.toUpperCase())}
              onKeyDown={(e) => e.key === 'Enter' && !loading && ticker.trim() && analyzeStock()}
              placeholder="Inserisci ticker (es: AAPL, TSLA, MSFT, NVDA...)"
              className="w-full pl-12 pr-4 py-4 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
            />
          </div>
          <button
            onClick={analyzeStock}
            disabled={loading || !ticker.trim()}
            className="px-8 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-xl font-semibold hover:from-emerald-600 hover:to-cyan-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            {loading ? (
              <>
                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                Analisi...
              </>
            ) : (
              <>
                <Brain className="w-5 h-5" />
                Analizza
              </>
            )}
          </button>
        </div>
      </div>

      {/* Results */}
      {analysis && !analysis.error && (
        <div className="max-w-7xl mx-auto">
          {/* Company Header */}
          <div className="bg-gradient-to-r from-slate-800/80 to-slate-800/60 backdrop-blur-sm rounded-xl p-6 mb-6 border border-slate-700/50">
            <div className="flex justify-between items-start">
              <div>
                <h2 className="text-3xl font-bold mb-2">{analysis.company}</h2>
                <p className="text-slate-400">{analysis.sector}</p>
              </div>
              <div className="text-right">
                <div className="text-4xl font-bold text-emerald-400">
                  ${analysis.currentPrice}
                </div>
                <div className={`text-lg ${analysis.priceChange?.startsWith('+') ? 'text-emerald-400' : 'text-red-400'}`}>
                  {analysis.priceChange}
                </div>
              </div>
            </div>
            <div className="mt-4 text-slate-400">
              Cap. di mercato: <span className="text-white font-semibold">{analysis.marketCap}</span>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mb-6 overflow-x-auto">
            {[
              { id: 'analysis', label: 'Analisi AI', icon: Brain },
              { id: 'technical', label: 'Analisi Tecnica', icon: Activity },
              { id: 'fundamentals', label: 'Fondamentali', icon: BarChart3 },
              { id: 'news', label: 'Notizie', icon: Newspaper }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all ${
                  activeTab === tab.id
                    ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 text-white'
                    : 'bg-slate-800/50 text-slate-400 hover:bg-slate-800'
                }`}
              >
                <tab.icon className="w-5 h-5" />
                {tab.label}
              </button>
            ))}
          </div>

          {/* Tab Content */}
          <div className="space-y-6">
            {activeTab === 'analysis' && (
              <>
                {/* Recommendation Card */}
                <div className={`rounded-xl p-6 border-2 ${
                  analysis.recommendation?.action === 'Acquisto' ? 'bg-emerald-500/10 border-emerald-500/50' :
                  analysis.recommendation?.action === 'Vendita' ? 'bg-red-500/10 border-red-500/50' :
                  'bg-amber-500/10 border-amber-500/50'
                }`}>
                  <div className="flex items-center gap-3 mb-4">
                    <DollarSign className="w-8 h-8" />
                    <div>
                      <h3 className="text-2xl font-bold">Raccomandazione: {analysis.recommendation?.action}</h3>
                      <p className="text-sm opacity-80">Confidenza: {analysis.recommendation?.confidence}</p>
                    </div>
                  </div>
                  <p className="mb-4">{analysis.recommendation?.reasoning}</p>
                  {analysis.recommendation?.targetPrice && (
                    <div className="text-lg">
                      <strong>Prezzo obiettivo:</strong> {analysis.recommendation.targetPrice}
                    </div>
                  )}
                </div>

                {/* AI Insights */}
                <div className="grid md:grid-cols-2 gap-6">
                  <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                    <h3 className="text-xl font-bold mb-4 text-emerald-400">‚úì Punti di Forza</h3>
                    <ul className="space-y-2">
                      {analysis.aiInsights?.strengths?.map((strength, i) => (
                        <li key={i} className="flex gap-2">
                          <span className="text-emerald-400">‚Ä¢</span>
                          <span>{strength}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                    <h3 className="text-xl font-bold mb-4 text-red-400">‚ö† Rischi</h3>
                    <ul className="space-y-2">
                      {analysis.aiInsights?.risks?.map((risk, i) => (
                        <li key={i} className="flex gap-2">
                          <span className="text-red-400">‚Ä¢</span>
                          <span>{risk}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>

                <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                  <h3 className="text-xl font-bold mb-3">üîÆ Prospettive</h3>
                  <p className="text-slate-300">{analysis.aiInsights?.outlook}</p>
                </div>
              </>
            )}

            {activeTab === 'technical' && (
              <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 className="text-2xl font-bold mb-6">Analisi Tecnica</h3>
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <div className="mb-4">
                      <span className="text-slate-400">Trend:</span>
                      <span className={`ml-2 font-bold ${
                        analysis.technicalAnalysis?.trend === 'Rialzista' ? 'text-emerald-400' :
                        analysis.technicalAnalysis?.trend === 'Ribassista' ? 'text-red-400' :
                        'text-amber-400'
                      }`}>
                        {analysis.technicalAnalysis?.trend}
                      </span>
                    </div>
                    <div className="mb-4">
                      <span className="text-slate-400">Supporto:</span>
                      <span className="ml-2 font-semibold">{analysis.technicalAnalysis?.support}</span>
                    </div>
                    <div>
                      <span className="text-slate-400">Resistenza:</span>
                      <span className="ml-2 font-semibold">{analysis.technicalAnalysis?.resistance}</span>
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold mb-2 text-slate-300">Indicatori:</h4>
                    <p className="text-slate-400">{analysis.technicalAnalysis?.indicators}</p>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'fundamentals' && (
              <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 className="text-2xl font-bold mb-6">Dati Fondamentali</h3>
                <div className="grid md:grid-cols-3 gap-6">
                  <div className="bg-slate-900/50 rounded-lg p-4">
                    <div className="text-slate-400 text-sm mb-1">P/E Ratio</div>
                    <div className="text-2xl font-bold">{analysis.fundamentals?.pe}</div>
                  </div>
                  <div className="bg-slate-900/50 rounded-lg p-4">
                    <div className="text-slate-400 text-sm mb-1">Fatturato</div>
                    <div className="text-2xl font-bold">{analysis.fundamentals?.revenue}</div>
                  </div>
                  <div className="bg-slate-900/50 rounded-lg p-4">
                    <div className="text-slate-400 text-sm mb-1">EPS</div>
                    <div className="text-2xl font-bold">{analysis.fundamentals?.eps}</div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'news' && (
              <div className="space-y-4">
                {analysis.recentNews?.map((news, i) => (
                  <div key={i} className="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50 hover:border-slate-600/50 transition-colors">
                    <div className="flex justify-between items-start mb-2">
                      <h4 className="font-bold text-lg">{news.title}</h4>
                      <span className="text-slate-400 text-sm">{news.date}</span>
                    </div>
                    <p className="text-slate-300">{news.summary}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {analysis?.error && (
        <div className="max-w-7xl mx-auto">
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6 text-center">
            <AlertCircle className="w-12 h-12 text-red-400 mx-auto mb-3" />
            <p className="text-red-200">{analysis.message}</p>
          </div>
        </div>
      )}

      {/* Quick Info */}
      {!analysis && !loading && (
        <div className="max-w-7xl mx-auto">
          <div className="grid md:grid-cols-3 gap-6">
            <div className="bg-slate-800/30 rounded-xl p-6 border border-slate-700/30">
              <Brain className="w-10 h-10 text-emerald-400 mb-3" />
              <h3 className="font-bold text-lg mb-2">Analisi AI Avanzata</h3>
              <p className="text-slate-400 text-sm">Ricerca web in tempo reale e analisi intelligente dei dati</p>
            </div>
            <div className="bg-slate-800/30 rounded-xl p-6 border border-slate-700/30">
              <Activity className="w-10 h-10 text-cyan-400 mb-3" />
              <h3 className="font-bold text-lg mb-2">Dati Aggiornati</h3>
              <p className="text-slate-400 text-sm">Prezzi, notizie e analisi tecniche sempre aggiornate</p>
            </div>
            <div className="bg-slate-800/30 rounded-xl p-6 border border-slate-700/30">
              <BarChart3 className="w-10 h-10 text-purple-400 mb-3" />
              <h3 className="font-bold text-lg mb-2">Analisi Completa</h3>
              <p className="text-slate-400 text-sm">Fondamentali, tecnica, sentiment e raccomandazioni</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default StockAnalyzer;
